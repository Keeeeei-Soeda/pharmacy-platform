name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  deploy:
    name: Deploy to yaku-navi.com
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          ssh-keyscan -H yaku-navi.com >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          ssh -i ~/.ssh/id_ed25519 -o StrictHostKeyChecking=no pharmacy@yaku-navi.com << 'DEPLOY_SCRIPT'
            set -e
            echo "========================================="
            echo "ðŸš€ è‡ªå‹•ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"
            echo "========================================="
            echo "æ™‚åˆ»: $(date)"
            echo ""
            
            cd ~/pharmacy-platform
            echo "ðŸ“‚ ç¾åœ¨ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª: $(pwd)"
            
            echo ""
            echo "========================================="
            echo "Step 1: æœ€æ–°ã‚³ãƒ¼ãƒ‰ã‚’å–å¾—"
            echo "========================================="
            git fetch origin
            git reset --hard origin/main
            git pull origin main
            
            echo ""
            echo "========================================="
            echo "Step 2: ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°"
            echo "========================================="
            npm install
            
            echo ""
            echo "========================================="
            echo "Step 3: ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã‚’ãƒ“ãƒ«ãƒ‰"
            echo "========================================="
            npm run build
            
            echo ""
            echo "========================================="
            echo "Step 4: ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ä¾å­˜é–¢ä¿‚ã‚’æ›´æ–°"
            echo "========================================="
            cd ~/pharmacy-platform/backend
            npm install
            
            echo ""
            echo "========================================="
            echo "Step 5: Prismaãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³"
            echo "========================================="
            cd ~/pharmacy-platform
            npx prisma generate
            npx prisma db push || echo "âš ï¸ ãƒžã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚¨ãƒ©ãƒ¼ï¼ˆã‚¹ã‚­ãƒ¼ãƒžãŒæ—¢ã«æœ€æ–°ã®å¯èƒ½æ€§ï¼‰"
            
            echo ""
            echo "========================================="
            echo "Step 6: PM2ã§ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å†èµ·å‹•"
            echo "========================================="
            pm2 restart pharmacy-frontend
            pm2 restart pharmacy-backend
            
            echo ""
            echo "========================================="
            echo "Step 7: PM2ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç¢ºèª"
            echo "========================================="
            pm2 status
            
            echo ""
            echo "========================================="
            echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†ï¼"
            echo "ðŸŒ https://yaku-navi.com/ ã§ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã™"
            echo "========================================="
          DEPLOY_SCRIPT

      - name: Deployment Status
        run: |
          echo "âœ… ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ­£å¸¸ã«å®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ðŸŒ https://yaku-navi.com/ ã§ç¢ºèªã—ã¦ãã ã•ã„"

