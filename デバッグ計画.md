# デバッグ計画（次チャット引き継ぎ用）

作成日: 2025-12-13  
対象: 薬剤師マッチングプラットフォーム（Next.js + Express + Prisma/PostgreSQL）

---

## 0. ゴール

- **画面の通し動作**（薬剤師・薬局）を、要件の主要導線に沿って確認し、必要な修正を完了する。
- **絶対ルール**を崩さず、ズレを再発させない。

---

## 1. 絶対ルール（このプロジェクトの前提）

### 1.1 命名規約

- **DB/Prisma（内部）**: `snake_case`（`prisma/schema.prisma` に準拠）
- **APIレスポンス（外部）**: **必ず `camelCase`**
- **変換点は1箇所**に集約（責務分散・二重変換を禁止）

### 1.2 変換の実装（現状）

- **バックエンドでレスポンスを camelCase に統一**
  - `backend/src/middleware/responseCase.js`（`res.json` をラップしてdeep変換）
  - `backend/src/app.js` で `app.use(responseCaseMiddleware)` を適用
- **フロントの変換はしない**
  - `lib/api-client.ts` から snake→camel 変換は撤去済み

### 1.3 “形”の統一（DTO）

camelCase変換だけでは `pharmacyProfiles` のような関係名が残るため、**API返却の「形」**はDTOで統一する。

- DTO実装: `backend/src/utils/dto.js`
  - 例: `contract.pharmacy`, `contract.application.jobPosting`, `thread.application.jobPosting` など

---

## 2. 現状の起動ポート（混乱防止）

### 2.1 バックエンド
- 通常: `http://localhost:3001`

### 2.2 フロントエンド
- **推奨（現在正常確認済み）**: `http://localhost:3005`
  - `.next` を削除してクリーン起動した dev サーバー
- 過去に自動割当されていたポート: `3002`
- `3000` は他プロセスで埋まることがあり、Nextが別ポートへ逃げる場合がある

---

## 3. 修正済みの重要ポイント（直近）

### 3.1 APIのケース/形の統一
- バックエンド: `res.json` 一律 camelCase 変換 + DTOで形統一
- 契約/メッセージ/求人/スケジュール/応募/通知の主要APIで、
  - **Prismaクエリはスキーマ準拠（snake_case）**
  - **返却JSONは camelCase + フロント期待形**

### 3.2 フロントビルドが通る状態に調整
- `npm run build` が成功する状態に修正（警告は残るが致命は解消）
- `lib/api-client.ts` の `Headers` 化（Authorizationヘッダーの型エラー解消）
- `lib/api/admin.ts` の fetchベースApiClientに合わせた修正（`response.data`/`params`排除）
- `lib/api/jobs.ts` に追加フィールド（`dailyRate` 等）を型追加
- ダッシュボードの `any` を削減（`WorkContract`型に寄せる等）
- `eslint.config.mjs` で `backend/**` を lint 対象外に設定（フロント確認を阻害しない）

---

## 4. これからのデバッグ方針（優先度順）

### P0: 画面の通し動作（ブラウザで確認）

#### 薬剤師側（必須フロー）
1. `/auth/login` で薬剤師ログイン
2. `/pharmacist/dashboard`
   - **募集検索**: 求人一覧が表示される
   - **メッセージ**: スレッド一覧→スレッド選択→送信→未読数変化
   - **契約管理**: 契約一覧→詳細→（承諾/辞退のUIがある場合）操作
   - **出勤予定**: スケジュール一覧/カレンダー表示
   - **通知ベル**: 未読バッジ→一覧→既読/削除

#### 薬局側（必須フロー）
1. `/auth/login` で薬局ログイン
2. `/pharmacy/dashboard`
   - **募集掲載**: 求人作成→一覧反映
   - **応募確認**: 応募一覧→承認/拒否（通知が飛ぶ）
   - **メッセージ**: スレッド→送信→未読数変化
   - **契約管理**: オファー送信→契約一覧反映
   - **勤務スケジュール**: 契約選択→カレンダー表示→詳細
   - **通知ベル**: 未読/既読/削除

> 画面でエラーが出たら「どのタブで、どの操作で、何が表示されたか（スクショ/コンソール）」を記録して次チャットで共有。

---

### P1: API通しスモーク（CLI）

画面が呼ぶ順に近い形で、主要APIが200で返るか確認する。

（例・薬剤師/薬局それぞれのJWTトークンを用意して実行）

```bash
# 薬剤師
curl -s http://localhost:3001/api/jobs -H "Authorization: Bearer $PHARMACIST_TOKEN" | jq '.jobs|type'
curl -s http://localhost:3001/api/messages/threads -H "Authorization: Bearer $PHARMACIST_TOKEN" | jq '.threads|type'
curl -s http://localhost:3001/api/contracts/pharmacist -H "Authorization: Bearer $PHARMACIST_TOKEN" | jq '.contracts|type'
curl -s http://localhost:3001/api/schedules/pharmacist/my -H "Authorization: Bearer $PHARMACIST_TOKEN" | jq '.schedules|type'
curl -s http://localhost:3001/api/notifications -H "Authorization: Bearer $PHARMACIST_TOKEN" | jq '.notifications|type'

# 薬局
curl -s http://localhost:3001/api/jobs/my/list -H "Authorization: Bearer $PHARMACY_TOKEN" | jq '.jobs|type'
curl -s http://localhost:3001/api/applications/pharmacy -H "Authorization: Bearer $PHARMACY_TOKEN" | jq '.applications|type'
curl -s http://localhost:3001/api/messages/threads -H "Authorization: Bearer $PHARMACY_TOKEN" | jq '.threads|type'
curl -s http://localhost:3001/api/contracts/pharmacy -H "Authorization: Bearer $PHARMACY_TOKEN" | jq '.contracts|type'
curl -s http://localhost:3001/api/schedules/pharmacy/my -H "Authorization: Bearer $PHARMACY_TOKEN" | jq '.schedules|type'
curl -s http://localhost:3001/api/notifications -H "Authorization: Bearer $PHARMACY_TOKEN" | jq '.notifications|type'
```

---

### P2: フロントの健全性（ビルド/型/最低限の静的検証）

```bash
cd /Users/soedakei/pharmacy-platform
npm run build
```

- **ビルド成功**が前提（警告は後回しでOK）
- `any` の使用箇所は減らす（致命になりやすいところから）

---

## 5. よくある不具合の切り分け

### 5.1 画面が500になる（devサーバー）
- `.next` の一時ファイル問題が出ることがある（Turbopack）
- 対処:
  1. dev停止
  2. `rm -rf .next`
  3. `npm run dev -- --port 3005`

### 5.2 画面で `undefined` が出る / 表示が空
- 原因候補
  - APIの「形」がフロント参照と違う（`contract.pharmacy` 等）
  - データが0件で UI が未考慮
  - 権限（userType）/ userId の一致不備
- 対処
  - 対象APIのレスポンスを `jq` で確認（camelCase/形）
  - `backend/src/utils/dto.js` のマッピングを修正

---

## 6. 次チャットで共有すると早い情報

- どのURL（`3005` 等）で、どのユーザー種別で、どのタブ/操作で問題が出たか
- ブラウザコンソールのエラー（先頭数行）
- バックエンドログ（該当リクエスト付近）
- 可能ならスクリーンショット

---

## 7. 起動コマンド（コピペ用）

### バックエンド
```bash
cd /Users/soedakei/pharmacy-platform/backend
npm start
```

### フロント（推奨: 3005）
```bash
cd /Users/soedakei/pharmacy-platform
rm -rf .next
npm run dev -- --port 3005
```


