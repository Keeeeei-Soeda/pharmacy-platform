# データベース構造とリレーション分析

**作成日:** 2025年12月14日  
**目的:** 応募承認・拒否機能のエラー原因究明

---

## 📊 1. Prismaスキーマのリレーション構造

### 応募データの取得フロー

```
job_applications (応募)
  ├─ job_postings (求人) ← フィールド名: job_postings
  │   └─ pharmacy_profiles (薬局) ← フィールド名: pharmacy_profiles
  │       └─ user_id ← フィールド名: user_id
  │
  └─ pharmacist_profiles (薬剤師) ← フィールド名: pharmacist_profiles
      └─ users (ユーザー) ← フィールド名: users
          └─ id
```

### 重要なポイント

**1. リレーションフィールド名は複数形**
```prisma
model job_applications {
  job_postings        job_postings?        @relation(...) // 複数形！
  pharmacist_profiles pharmacist_profiles? @relation(...) // 複数形！
}

model job_postings {
  pharmacy_profiles pharmacy_profiles? @relation(...) // 複数形！
}
```

**2. しかし、関係性は1対1または多対1**
- `job_applications` → `job_postings` : 多対1 (多くの応募が1つの求人に)
- `job_postings` → `pharmacy_profiles` : 多対1 (多くの求人が1つの薬局に)

**→ 論理的には単数形であるべきだが、スキーマでは複数形になっている**

---

## 🔄 2. データ変換の流れ

### Step 1: Prismaクエリ実行（snake_case）

```javascript
const application = await prisma.job_applications.findUnique({
  where: { id },
  include: {
    job_postings: {           // ← リレーション名（複数形）
      include: {
        pharmacy_profiles: {  // ← リレーション名（複数形）
          select: {
            user_id: true,    // ← フィールド名（snake_case）
            pharmacy_name: true
          }
        }
      }
    }
  }
});
```

**結果の構造（Prisma生データ）:**
```javascript
{
  id: "...",
  job_posting_id: "...",
  job_postings: {           // ← snake_case、複数形
    id: "...",
    title: "...",
    pharmacy_profiles: {    // ← snake_case、複数形
      user_id: "...",       // ← snake_case
      pharmacy_name: "..."
    }
  }
}
```

### Step 2: DTOミドルウェア変換（camelCase）

```javascript
// middleware/responseCase.js
function toCamelKey(key) {
  return key.replace(/_([a-z])/g, (_, letter) => letter.toUpperCase());
}
```

**変換後:**
```javascript
{
  id: "...",
  jobPostingId: "...",
  jobPostings: {           // ← camelCase、複数形のまま
    id: "...",
    title: "...",
    pharmacyProfiles: {    // ← camelCase、複数形のまま
      userId: "...",       // ← camelCase
      pharmacyName: "..."
    }
  }
}
```

### Step 3: コントローラーでのアクセス

**正しいパス:**
```javascript
application.jobPostings.pharmacyProfiles.userId  ✅
```

**間違ったパス（以前のコード）:**
```javascript
application.jobPosting.pharmacyProfile.userId    ❌ (単数形)
application.jobPosting.pharmacy.userId           ❌ (pharmacy は存在しない)
```

---

## 🐛 3. 発生していた問題

### 問題1: フィールド名のケース違い
```javascript
// ❌ 間違い（camelCase）
pharmacy_profiles: {
  select: {
    userId: true  // ← Prismaではsnake_caseを使う！
  }
}

// ✅ 正しい（snake_case）
pharmacy_profiles: {
  select: {
    user_id: true  // ← Prismaクエリでは常にsnake_case
  }
}
```

### 問題2: リレーション名の単数形・複数形
```javascript
// ❌ 間違い
application.jobPosting.pharmacyProfile.userId

// ✅ 正しい
application.jobPostings.pharmacyProfiles.userId
```

### 問題3: 存在しないフィールド名
```javascript
// ❌ 間違い
application.jobPosting.pharmacy.userId  // pharmacy は存在しない

// ✅ 正しい
application.jobPostings.pharmacyProfiles.userId
```

---

## 🔧 4. 修正内容

### 修正ファイル
- `backend/src/controllers/applicationController.js`

### 修正箇所（計9箇所）

| 行番号 | 修正内容 | 説明 |
|--------|----------|------|
| 419 | `jobPosting` → `jobPostings` | リレーション名を複数形に |
| 419 | `pharmacy` → `pharmacyProfiles` | 正しいリレーション名に |
| 448 | `userId` → `user_id` | Prismaクエリでsnake_caseに |
| 471 | `jobPosting` → `jobPostings` | リレーション名を複数形に |
| 471 | `pharmacyProfile` → `pharmacyProfiles` | リレーション名を複数形に |
| 500 | `jobPosting` → `jobPostings` | リレーション名を複数形に |
| 531 | `userId` → `user_id` | Prismaクエリでsnake_caseに |
| 554 | `jobPosting` → `jobPostings` | リレーション名を複数形に |
| 554 | `pharmacyProfile` → `pharmacyProfiles` | リレーション名を複数形に |
| 584 | `jobPosting` → `jobPostings` | リレーション名を複数形に |
| 659 | `jobPosting` → `jobPostings` | リレーション名を複数形に |
| 659 | `pharmacy` → `pharmacyProfiles` | 正しいリレーション名に |
| 662 | `jobPosting` → `jobPostings` | リレーション名を複数形に |

---

## 🧪 5. 現在の状況確認

### デバッグログを確認する必要があります

**承認ボタンをクリックした後、以下のログが表示されるはずです:**
```
Application keys: [...]
job_postings: {...}
jobPostings: {...}
```

**このログが表示されない場合:**
- デプロイが正しく反映されていない
- または別のエラーで処理が到達していない

---

## 🎯 6. 次の確認手順

### Step 1: 承認ボタンをクリック（未実施）

### Step 2: ログ確認
```bash
ssh root@162.43.8.168 "pm2 logs pharmacy-backend --lines 50"
```

期待される出力:
- `Application keys: [...]` ← データ構造の確認
- `job_postings: {...}` ← Prisma生データ
- `jobPostings: {...}` ← DTO変換後データ

### Step 3: ログに基づいて対応
- ログが表示される → データ構造を確認して最終修正
- ログが表示されない → 別のエラーが発生している

---

## 💡 7. 根本原因のまとめ

### 問題の本質
```
Prismaスキーマの設計
  ↓
リレーション名が複数形（job_postings, pharmacy_profiles）
  ↓
しかし、論理的には1対1なので単数形であるべき
  ↓
コードで単数形を想定
  ↓
不一致エラー発生
```

### 解決方法
**短期（現在実施中）:**
- コードをスキーマに合わせて複数形に修正

**長期（推奨）:**
- Prismaスキーマのリレーション名を単数形に変更
- より直感的で保守しやすいコードに

---

## 🔍 8. まだ確認が必要なこと

1. **デバッグログの確認** ← 最優先
   - 実際のデータ構造を確認
   - DTOミドルウェアが正しく動作しているか

2. **他のコントローラーの確認**
   - 同様の問題が他にもないか
   - 全体的なコードレビュー

3. **エラーハンドリングの改善**
   - より詳細なエラーメッセージ
   - デバッグしやすいログ出力

---

**次のステップ:** 承認ボタンをクリックして、デバッグログを確認してください 🔍

